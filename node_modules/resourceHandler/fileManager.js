var fs = require('fs');
var dest = require('./dest/file.js');

/*
    TODO Error handling
    file write is not save - it could be outsynced if two writes to the content
*/
var fileMgr =  {};
fileMgr.readFile = function(file,callbackJSON){
    var file = file;
    var cb = callbackJSON;
    fs.exists(file,function(exists){
        if(exists){
            fs.readFile(file,'utf8', function (err, data) {
                if (err) throw err;
                cb(getObject(data));
            });
        }
    })
}
fileMgr.writeFile = function(file,key,value,callback){
    var file = file,key = key, value = value;
    var cb = callback; 
    var reg = new RegExp('(.*)'+key+'=(.*)([\n\r]*.*)','g');

    fs.exists(file,function(exists){
        if(exists){
            fs.readFile(file,'utf8', function (err, data) {
                if (err) throw err;
                var result = data.replace(reg,'$1'+key+'='+value+'$3');
                fs.writeFile(file,result,'utf8',function(err){
                    if (err) return console.log(err);
                    cb(key,value);
                });
            });
        }
    })
}

var getObject = function(data){
    var reg = new RegExp('([a-zA-Z\d_\.]*)=(.*)[\n\r]*','g');
    var match = data.split(reg);
    var list = [];
    for (var i = 0; i < match.length-1; i+=3) {
//        console.log("--------------------");
//        console.log(match[i]+" : "+match[i+2])
        list.push({
            key : match[i],
            data: match[i+2]
        });
    }
    return {data : list};
}

module.exports = fileMgr;
